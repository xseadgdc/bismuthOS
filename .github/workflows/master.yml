name: Bulk Fork Components
on: 
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of repos to fork (e.g., 5)'
        required: true
        default: '5'

jobs:
  fork_repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Manifest Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures the runner pulls actual file content, not just refs

      - name: Parse and Mirror
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
        run: |
          # 1. Identify the manifest
          MANIFEST_FILE="full.xml"

          # 2. Strict Extraction
          # We only want names that do NOT end in .xml and are not the manifest itself
          REPOS=$(perl -ne 'print "$1\n" if /name=["\x27]([^"\x27]+)["\x27]/' "$MANIFEST_FILE" | grep -v '\.xml$' | grep -v 'manifest' | head -n ${{ github.event.inputs.limit }})

          if [ -z "$REPOS" ]; then
            echo "ERROR: No valid repositories found."
            exit 1
          fi

          for REPO in $REPOS; do
            # Clean name for GitHub (replace slashes, dots, and colons)
            NAME=$(echo "$REPO" | sed 's/[\/\.:]/-/g')
            
            echo "------------------------------------------"
            echo "Processing: $REPO -> $NAME"
            
            # Create the repo on GitHub
            gh repo create "$NAME" --public --description "bismuthOS component: $REPO" || echo "Repo $NAME already exists."
            
            # Set source URL - Append .git if not present
            SOURCE_URL="https://chromium.googlesource.com/$REPO.git"
            
            # Configure Git for 2026 stability
            git config --global http.version HTTP/1.1
            
            if git clone --mirror "$SOURCE_URL" temp-dir; then
              cd temp-dir
              
              # FIX: Use the environment variable REPO_OWNER instead of the double-curly brace syntax in the shell
              REMOTE_URL="https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/${NAME}.git"
              
              git remote add github "$REMOTE_URL"
              
              echo "Pushing to GitHub..."
              git push --mirror github || echo "Push failed for $NAME"
              
              cd ..
              rm -rf temp-dir
              echo "Successfully finished $NAME"
            else
              echo "Failed to clone $SOURCE_URL - skipping."
              rm -rf temp-dir
            fi
          done
