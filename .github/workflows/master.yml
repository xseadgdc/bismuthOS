name: Bulk Fork Components
on: 
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of repos to fork (e.g., 5)'
        required: true
        default: '5'

jobs:
  fork_repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Manifest Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures the runner pulls actual file content, not just refs

      - name: Parse and Mirror
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
        run: |
          # 1. Verify manifest existence
          MANIFEST_FILE="full.xml"
          
          # 2. Indestructible Extraction
          # We capture the name and ensure we don't pick up the manifest itself
          REPOS=$(perl -ne 'print "$1\n" if /name=["\x27]([^"\x27]+)["\x27]/' "$MANIFEST_FILE" | grep -v 'manifest' | head -n ${{ github.event.inputs.limit }})

          if [ -z "$REPOS" ]; then
            echo "ERROR: Extraction failed."
            exit 1
          fi

          # 3. Process the loop
          for REPO in $REPOS; do
            # Clean name for GitHub (replace slashes, dots, and colons)
            NAME=$(echo "$REPO" | sed 's/[\/\.:]/-/g')
            
            echo "Processing: $REPO -> $NAME"
            
            # Create the repo
            gh repo create "$NAME" --public --description "BismuthOS component: $REPO" || echo "Repo exists."
            
            # Stable mirror settings
            git config --global http.version HTTP/1.1
            
            # FIX: Check if the REPO name already starts with chromiumos/ or infra/
            # If it does, we don't add anything extra.
            if [[ "$REPO" == http* ]]; then
               SOURCE_URL="$REPO"
            else
               SOURCE_URL="https://chromium.googlesource.com/$REPO.git"
            fi

            echo "Cloning from: $SOURCE_URL"
            
            if git clone --mirror "$SOURCE_URL" temp-dir; then
              cd temp-dir
              git remote add github "https://x-access-token:${GH_TOKEN}@github.com{{ github.repository_owner }}/$NAME.git"
              # Force push to ensure it works even if repo was partially initialized
              git push --mirror github || echo "Push failed for $NAME"
              cd ..
              rm -rf temp-dir
              echo "Successfully finished $NAME"
            else
              echo "Failed to clone $SOURCE_URL - skipping."
              cd "$GITHUB_WORKSPACE"
              rm -rf temp-dir
            fi
          done
