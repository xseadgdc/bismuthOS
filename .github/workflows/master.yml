name: Bulk Fork Components
on: 
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of repos to fork (e.g., 5)'
        required: true
        default: '5'

jobs:
  fork_repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download default.xml
        run: |
          curl -s -o default.xml https://chromium.googlesource.com/chromiumos/manifest.git/+/refs/heads/main/default.xml?format=TEXT
          echo "$(<default.xml)" | base64 -d > default.xml

      - name: Parse and Mirror
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
        run: |
          # 1. Determine the real manifest file (Resolve symlinks)
          MANIFEST_FILE="default.xml"
          
          # If it's a symlink, find where it points
          if [ -L "$MANIFEST_FILE" ]; then
            TARGET=$(readlink "$MANIFEST_FILE")
            echo "default.xml is a symlink to: $TARGET"
            MANIFEST_FILE="$TARGET"
          fi

          # Fail safely if the file doesn't exist or is empty
          if [ ! -f "$MANIFEST_FILE" ] || [ ! -s "$MANIFEST_FILE" ]; then
            echo "ERROR: $MANIFEST_FILE not found or empty. Checking for full.xml..."
            if [ -f "full.xml" ]; then MANIFEST_FILE="full.xml"; else exit 1; fi
          fi

          echo "Using manifest source: $MANIFEST_FILE"

          # 2. Extract project names using a more robust regex
          REPOS=$(grep -E '<project.*name=' "$MANIFEST_FILE" | sed -E 's/.*name="([^"]+)".*/\1/' | grep -v '\.xml' | head -n ${{ github.event.inputs.limit }})

          if [ -z "$REPOS" ]; then
            echo "ERROR: No repositories found in $MANIFEST_FILE."
            exit 1
          fi

          for REPO in $REPOS; do
            NAME=$(echo "$REPO" | sed 's/\//-/g')
            echo "Processing: $REPO as $NAME"

            gh repo create "$NAME" --public --description "chromiumos: $REPO" || echo "Repo may already exist"

            git clone --mirror "https://chromium.googlesource.com/chromiumos/$REPO.git" temp-dir
            cd temp-dir

            git remote add github "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/$NAME.git"
            git push --mirror github

            cd ..
            rm -rf temp-dir
            echo "Mirrored: $NAME"
          done   
